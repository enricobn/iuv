package org.iuv.test.client

import kotlinx.serialization.ImplicitReflectionSerializer
import kotlinx.serialization.internal.ArrayListSerializer
import kotlinx.serialization.internal.UnitSerializer
import kotlinx.serialization.serializer
import org.iuv.core.Authentication
import org.iuv.core.Http
import org.iuv.core.HttpMethod
import org.iuv.shared.Task
import org.iuv.test.models.NewPet
import org.iuv.test.models.Pet

class PetStoreApiImpl(private val baseUrl : String = "http://petstore.swagger.io/api") : PetStoreApi {
    private var authentication : Authentication? = null

    override fun authenticate(authentication: Authentication) {
        this.authentication = authentication
    }

    @ImplicitReflectionSerializer
    override fun findPets(tags : List<String>?, limit : Int?) : Task<String,List<Pet>> {
        val runner = Http.runner(HttpMethod.Get, "$baseUrl/pets", ArrayListSerializer(Pet::class.serializer()))
            .queryParams(
                "tags" to tags,
                "limit" to limit
            )
        authentication.let {
            if (it != null) {
                runner.configuration(it)
            }
        }
        return runner.run()
    }

    @ImplicitReflectionSerializer
    override fun addPet(body : NewPet) : Task<String,Pet> {
        val runner = Http.runner(HttpMethod.Post, "$baseUrl/pets", Pet::class.serializer())
            .body(body, NewPet::class.serializer())
        authentication.let {
            if (it != null) {
                runner.configuration(it)
            }
        }
        return runner.run()
    }

    @ImplicitReflectionSerializer
    override fun findPetById(id : Long) : Task<String,Pet> {
        val runner = Http.runner(HttpMethod.Get, "$baseUrl/pets/$id", Pet::class.serializer())
        authentication.let {
            if (it != null) {
                runner.configuration(it)
            }
        }
        return runner.run()
    }

    @ImplicitReflectionSerializer
    override fun deletePet(id : Long) : Task<String,Unit> {
        val runner = Http.runner(HttpMethod.Delete, "$baseUrl/pets/$id", UnitSerializer)
        authentication.let {
            if (it != null) {
                runner.configuration(it)
            }
        }
        return runner.run()
    }

}